# ============================================
# APACHE 2.4 - TransitGuinée Secure
# Fichier: /etc/apache2/sites-available/transitguinee.conf
# ============================================

<VirtualHost *:80>
    ServerName transitguinee.com
    ServerAlias www.transitguinee.com
    
    # ACME challenge pour Let's Encrypt
    Alias /.well-known/acme-challenge/ /var/www/certbot/.well-known/acme-challenge/
    <Directory /var/www/certbot/.well-known/acme-challenge/>
        Require all granted
    </Directory>
    
    # Redirection HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName transitguinee.com
    ServerAlias www.transitguinee.com
    
    DocumentRoot /var/www/transitguinee/dist
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/transitguinee-error.log
    CustomLog ${APACHE_LOG_DIR}/transitguinee-access.log combined
    
    # ============================================
    # SSL/TLS
    # ============================================
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/transitguinee.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/transitguinee.com/privkey.pem
    
    # Protocoles modernes
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    
    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingCache "shmcb:/var/cache/apache2/ssl_stapling(32768)"
    
    # ============================================
    # HEADERS DE SÉCURITÉ
    # ============================================
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # CSP - PRODUCTION: Retirer unsafe-inline/unsafe-eval
    # Générer hashes: echo -n "<script>code</script>" | openssl dgst -sha256 -binary | openssl base64
    Header always set Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self'; \
        style-src 'self' https://fonts.googleapis.com; \
        font-src 'self' https://fonts.gstatic.com; \
        img-src 'self' data: https:; \
        connect-src 'self' https://api.transitguinee.com; \
        frame-ancestors 'none'; \
        base-uri 'self'; \
        form-action 'self';\
    "
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
    
    # ============================================
    # RATE LIMITING (Protection DDoS)
    # ============================================
    <IfModule mod_evasive24.c>
        DOSHashTableSize 3097
        DOSPageCount 10         # Max 10 requêtes/page/seconde
        DOSSiteCount 50         # Max 50 requêtes/site/seconde
        DOSPageInterval 1
        DOSSiteInterval 1
        DOSBlockingPeriod 60    # Bloquer IP pendant 60s
        DOSEmailNotify security@transitguinee.com
        DOSLogDir /var/log/apache2/mod_evasive
    </IfModule>
    
    # Limite taille uploads (5MB)
    LimitRequestBody 5242880
    
    # ============================================
    # COMPRESSION
    # ============================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
    
    # ============================================
    # CACHE ASSETS
    # ============================================
    <Directory /var/www/transitguinee/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Activer mod_rewrite pour SPA
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Assets avec hash - Cache 1 an
    <FilesMatch "\.(js|css|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Images et fonts - Cache 6 mois
    <FilesMatch "\.(png|jpg|jpeg|gif|ico|svg|webp|woff|ttf|eot)$">
        Header set Cache-Control "public, max-age=15552000"
    </FilesMatch>
    
    # Service Worker - Pas de cache
    <Files "sw.js">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </Files>
    
    # Manifest - Cache 1 jour
    <FilesMatch "manifest\.(json|webmanifest)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
    
    # ============================================
    # API PROXY (si backend séparé)
    # ============================================
    ProxyPreserveHost On
    
    # API générale (30s timeout pour 3G Guinée)
    <Location /api/>
        ProxyPass http://localhost:3000/api/ timeout=30
        ProxyPassReverse http://localhost:3000/api/
        
        # CORS
        Header always set Access-Control-Allow-Origin "https://transitguinee.com"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        Header always set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
        
        # Pas de cache API
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </Location>
    
    # Login endpoint (timeout court 10s)
    <Location /api/auth/login>
        ProxyPass http://localhost:3000/api/auth/login timeout=10
        ProxyPassReverse http://localhost:3000/api/auth/login
    </Location>
    
    # ============================================
    # PROTECTION FICHIERS SENSIBLES
    # ============================================
    
    # Robots.txt (bloquer indexation API)
    Alias /robots.txt /var/www/transitguinee/robots.txt
    <Location /robots.txt>
        Header set Content-Type "text/plain"
    </Location>
    
    # Bloquer accès fichiers cachés (.env, .git, etc.)
        Require all denied
    </FilesMatch>
</VirtualHost>

# ============================================
# MODULES REQUIS
# ============================================
# sudo a2enmod ssl rewrite headers deflate proxy proxy_http evasive
# sudo apt install libapache2-mod-evasive
# sudo mkdir -p /var/log/apache2/mod_evasive
# sudo chown www-data:www-data /var/log/apache2/mod_evasive
# sudo a2ensite transitguinee.conf
# sudo systemctl reload apache2
# 
# Créer robots.txt:
# echo -e "User-agent: *\nDisallow: /api/\nAllow: /" | sudo tee /var/www/transitguinee/robots.txt
